{% extends "base.html" %}

{% block title %}AI Generated Images Gallery - The Wireless Monitor{% endblock %}

{% block content %}
<div style="max-width: 1400px; margin: 0 auto;">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); border-radius: 12px;">
        <div>
            <h1 style="font-family: 'Playfair Display', serif; font-size: 2.2rem; margin: 0; color: #333;">ğŸ–¼ï¸ AI Generated Images Gallery</h1>
            <p style="margin: 5px 0 0 0; opacity: 0.8; font-size: 1rem; color: #555;">{{ images|length }} images created by our enhanced scraping and AI system</p>
        </div>
        <div style="display: flex; gap: 10px;">
            <a href="{{ url_for('admin', view=view_mode) }}" class="btn" style="background: #6c757d;">â† Back to Admin</a>
            <button onclick="clearAllImages()" class="btn" style="background: #dc3545;">ğŸ—‘ï¸ Clear All</button>
        </div>
    </div>

    <!-- Stats Bar -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 12px; text-align: center;">
            <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“·</div>
            <div style="font-size: 2rem; font-weight: 700;">{{ scraped_count }}</div>
            <div style="font-size: 0.9rem; opacity: 0.9;">Scraped Images</div>
        </div>
        
        <div style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white; padding: 20px; border-radius: 12px; text-align: center;">
            <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ¨</div>
            <div style="font-size: 2rem; font-weight: 700;">{{ ai_generated_count }}</div>
            <div style="font-size: 0.9rem; opacity: 0.9;">AI Generated</div>
        </div>
        
        <div style="background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; padding: 20px; border-radius: 12px; text-align: center;">
            <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“Š</div>
            <div style="font-size: 2rem; font-weight: 700;">{{ "%.1f"|format((scraped_count / images|length * 100) if images|length > 0 else 0) }}%</div>
            <div style="font-size: 0.9rem; opacity: 0.9;">Scraping Success</div>
        </div>
        
        <div style="background: linear-gradient(135deg, #43e97b, #38f9d7); color: white; padding: 20px; border-radius: 12px; text-align: center;">
            <div style="font-size: 2rem; margin-bottom: 10px;">âš¡</div>
            <div style="font-size: 2rem; font-weight: 700;">{{ images|length }}</div>
            <div style="font-size: 0.9rem; opacity: 0.9;">Total Images</div>
        </div>
    </div>

    <!-- Filter Controls -->
    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-bottom: 15px;">
            <label style="font-weight: 600; color: #2c3e50;">Filter:</label>
            <button onclick="filterImages('all')" class="filter-btn active" data-filter="all">All Images</button>
            <button onclick="filterImages('scraped')" class="filter-btn" data-filter="scraped">ğŸ“· Scraped Only</button>
            <button onclick="filterImages('ai')" class="filter-btn" data-filter="ai">ğŸ¨ AI Generated Only</button>
            <button onclick="filterImages('recent')" class="filter-btn" data-filter="recent">ğŸ•’ Recent (24h)</button>
        </div>
        
        <!-- Bulk Actions -->
        <div id="bulkActions" style="display: none; padding-top: 15px; border-top: 1px solid #eee;">
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <span style="font-weight: 600; color: #2c3e50;">Bulk Actions:</span>
                <span id="selectedCount" style="color: #666; font-size: 0.9rem;">0 selected</span>
                <button onclick="selectAll()" class="btn" style="background: #6c757d; font-size: 0.8rem; padding: 6px 12px;">Select All Visible</button>
                <button onclick="clearSelection()" class="btn" style="background: #6c757d; font-size: 0.8rem; padding: 6px 12px;">Clear Selection</button>
                <button onclick="bulkDelete()" class="btn" style="background: #dc3545; font-size: 0.8rem; padding: 6px 12px;">ğŸ—‘ï¸ Delete Selected</button>
                <button onclick="bulkRegenerate()" class="btn" style="background: #28a745; font-size: 0.8rem; padding: 6px 12px;">ğŸ”„ Regenerate Selected</button>
            </div>
        </div>
    </div>

    <!-- Images Gallery -->
    {% if images %}
    <div class="gallery-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px;">
        {% for image in images %}
        <div class="gallery-item" 
             data-type="{% if '/static/generated_images/' in image.image_url %}ai{% else %}scraped{% endif %}"
             data-date="{{ image.created_at }}"
             data-article-id="{{ image.id }}"
             style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: transform 0.2s ease;">
            
            <!-- Selection Checkbox -->
            <div style="position: absolute; top: 10px; left: 10px; z-index: 3;">
                <input type="checkbox" class="image-checkbox" data-article-id="{{ image.id }}" 
                       onchange="updateSelection()" 
                       style="width: 18px; height: 18px; cursor: pointer;">
            </div>
            
            <!-- Image -->
            <div style="position: relative; height: 200px; overflow: hidden;">
                <img src="{{ image.image_url }}" 
                     alt="{{ image.title }}" 
                     style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;"
                     onclick="openImageModal('{{ image.image_url }}', '{{ image.title }}', '{{ image.feed_name }}')">
                
                <!-- Type Badge -->
                <div style="position: absolute; top: 10px; right: 10px; background: {% if '/static/generated_images/' in image.image_url %}linear-gradient(135deg, #f093fb, #f5576c){% else %}linear-gradient(135deg, #667eea, #764ba2){% endif %}; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 600;">
                    {% if '/static/generated_images/' in image.image_url %}ğŸ¨ AI{% else %}ğŸ“· Scraped{% endif %}
                </div>
            </div>
            
            <!-- Content -->
            <div style="padding: 20px;">
                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 10px; line-height: 1.3; color: #2c3e50;">
                    {{ image.title[:80] }}{% if image.title|length > 80 %}...{% endif %}
                </h3>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span style="font-size: 0.8rem; color: #666; background: #f8f9fa; padding: 4px 8px; border-radius: 12px;">
                        {{ image.feed_name }}
                    </span>
                    <span style="font-size: 0.8rem; color: #999;">
                        {{ image.created_at[:10] }}
                    </span>
                </div>
                
                <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                    <a href="{{ image.url }}" target="_blank" class="btn" style="flex: 1; font-size: 0.75rem; padding: 6px 10px;">
                        ğŸ“° Article
                    </a>
                    <button onclick="copyImageUrl('{{ image.image_url }}')" class="btn" style="background: #6c757d; font-size: 0.75rem; padding: 6px 10px;">
                        ğŸ“‹ Copy
                    </button>
                    <button onclick="regenerateImage({{ image.id }})" class="btn" style="background: #28a745; font-size: 0.75rem; padding: 6px 10px;">
                        ğŸ”„ Regen
                    </button>
                    <button onclick="deleteImage({{ image.id }})" class="btn" style="background: #dc3545; font-size: 0.75rem; padding: 6px 10px;">
                        ğŸ—‘ï¸ Del
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <div style="font-size: 4rem; margin-bottom: 20px; opacity: 0.3;">ğŸ–¼ï¸</div>
        <h3 style="color: #666; margin-bottom: 10px;">No Images Generated Yet</h3>
        <p style="color: #999; margin-bottom: 20px;">Images will appear here as articles are fetched and processed.</p>
        <a href="{{ url_for('index', view=view_mode) }}" class="btn">â† Back to Headlines</a>
    </div>
    {% endif %}
</div>

<!-- Image Modal -->
<div id="imageModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; cursor: pointer;" onclick="closeImageModal()">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 90%; max-height: 90%;">
        <img id="modalImage" style="max-width: 100%; max-height: 100%; border-radius: 8px;">
        <div id="modalCaption" style="color: white; text-align: center; padding: 20px; font-size: 1.1rem; font-weight: 500;"></div>
    </div>
    <div style="position: absolute; top: 20px; right: 20px; color: white; font-size: 2rem; cursor: pointer;" onclick="closeImageModal()">Ã—</div>
</div>

<style>
.gallery-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.filter-btn {
    padding: 8px 16px;
    border: 2px solid #e9ecef;
    background: white;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.2s ease;
    color: #666;
}

.filter-btn:hover {
    border-color: #667eea;
    color: #667eea;
}

.filter-btn.active {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-color: #667eea;
    color: white;
}

.gallery-item.hidden {
    display: none;
}
</style>

<script>
let selectedImages = new Set();

function updateSelection() {
    const checkboxes = document.querySelectorAll('.image-checkbox:checked');
    selectedImages.clear();
    
    checkboxes.forEach(cb => {
        selectedImages.add(parseInt(cb.getAttribute('data-article-id')));
    });
    
    const count = selectedImages.size;
    document.getElementById('selectedCount').textContent = `${count} selected`;
    document.getElementById('bulkActions').style.display = count > 0 ? 'block' : 'none';
}

function selectAll() {
    const visibleCheckboxes = document.querySelectorAll('.gallery-item:not(.hidden) .image-checkbox');
    visibleCheckboxes.forEach(cb => cb.checked = true);
    updateSelection();
}

function clearSelection() {
    const checkboxes = document.querySelectorAll('.image-checkbox');
    checkboxes.forEach(cb => cb.checked = false);
    updateSelection();
}

async function bulkDelete() {
    if (selectedImages.size === 0) return;
    
    if (!confirm(`Delete ${selectedImages.size} selected images? This cannot be undone.`)) return;
    
    try {
        const response = await fetch('/api/bulk_delete_images', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ article_ids: Array.from(selectedImages) })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`âœ… Successfully deleted ${data.deleted_count} images!`);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
}

async function bulkRegenerate() {
    if (selectedImages.size === 0) return;
    
    if (!confirm(`Regenerate ${selectedImages.size} selected images? This may take a while.`)) return;
    
    try {
        const response = await fetch('/api/bulk_regenerate_images', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ article_ids: Array.from(selectedImages) })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`âœ… Successfully regenerated ${data.regenerated_count} of ${data.total_requested} images!`);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
}

async function deleteImage(articleId) {
    if (!confirm('Delete this image? This cannot be undone.')) return;
    
    try {
        const response = await fetch('/api/bulk_delete_images', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ article_ids: [articleId] })
        });
        
        const data = await response.json();
        
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
}

async function regenerateImage(articleId) {
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = 'â³ Regen...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/bulk_regenerate_images', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ article_ids: [articleId] })
        });
        
        const data = await response.json();
        
        if (data.success) {
            btn.textContent = 'âœ… Done!';
            setTimeout(() => location.reload(), 1500);
        } else {
            btn.textContent = 'âŒ Failed';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
            }, 2000);
        }
    } catch (error) {
        btn.textContent = 'âŒ Error';
        setTimeout(() => {
            btn.textContent = originalText;
            btn.disabled = false;
        }, 2000);
    }
}

function filterImages(type) {
    const items = document.querySelectorAll('.gallery-item');
    const buttons = document.querySelectorAll('.filter-btn');
    
    // Update active button
    buttons.forEach(btn => btn.classList.remove('active'));
    document.querySelector(`[data-filter="${type}"]`).classList.add('active');
    
    // Filter items
    items.forEach(item => {
        const itemType = item.getAttribute('data-type');
        const itemDate = new Date(item.getAttribute('data-date'));
        const now = new Date();
        const dayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
        
        let show = false;
        
        switch(type) {
            case 'all':
                show = true;
                break;
            case 'scraped':
                show = itemType === 'scraped';
                break;
            case 'ai':
                show = itemType === 'ai';
                break;
            case 'recent':
                show = itemDate > dayAgo;
                break;
        }
        
        item.classList.toggle('hidden', !show);
    });
    
    // Update selection after filtering
    updateSelection();
}

function openImageModal(imageUrl, title, feedName) {
    document.getElementById('modalImage').src = imageUrl;
    document.getElementById('modalCaption').textContent = `${title} - ${feedName}`;
    document.getElementById('imageModal').style.display = 'block';
}

function closeImageModal() {
    document.getElementById('imageModal').style.display = 'none';
}

function copyImageUrl(url) {
    navigator.clipboard.writeText(url).then(() => {
        // Show temporary success message
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'âœ… Copied!';
        btn.style.background = '#28a745';
        setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = '#6c757d';
        }, 2000);
    });
}

async function clearAllImages() {
    if (!confirm('Clear all generated images? This cannot be undone.')) return;
    
    try {
        const response = await fetch('/api/clear_generated_images', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
}

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeImageModal();
    }
});
</script>
{% endblock %}