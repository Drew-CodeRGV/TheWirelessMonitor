{% extends "base.html" %}

{% block title %}The Wireless Monitor - GitHub Integration{% endblock %}

{% block content %}
<div class="section-header">GitHub Repository Management</div>

<div class="articles-grid">
    <div class="main-articles">
        <!-- GitHub Configuration -->
        <article class="newspaper-article">
            <h3 class="article-headline">GitHub Account Configuration</h3>
            <div class="article-byline">
                Connect your GitHub account to publish The Wireless Monitor project
            </div>
            
            <form method="POST" action="{{ url_for('save_github_config') }}" style="margin: 25px 0;">
                <!-- GitHub Token -->
                <div style="margin-bottom: 25px; padding: 20px; border: 2px solid #333; background: #f8f8f8;">
                    <h4 style="margin: 0 0 15px 0;">
                        <i class="fab fa-github"></i> GitHub Personal Access Token
                    </h4>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px;">
                            Personal Access Token:
                        </label>
                        <input type="password" name="github_token" 
                               value="{{ github_token or '' }}"
                               placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" 
                               style="width: 100%; padding: 8px; border: 1px solid #ccc; font-size: 1rem; font-family: monospace;">
                    </div>
                    <small style="color: #666;">
                        <strong>Required Permissions:</strong> repo, user, admin:repo_hook<br>
                        <a href="https://github.com/settings/tokens/new" target="_blank" style="color: #000080;">
                            ¬ª Create new token on GitHub
                        </a>
                    </small>
                </div>
                
                <!-- GitHub Username -->
                <div style="margin-bottom: 25px; padding: 20px; border: 2px solid #333; background: #f8f8f8;">
                    <h4 style="margin: 0 0 15px 0;">
                        <i class="fas fa-user"></i> GitHub Username
                    </h4>
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px;">Username:</label>
                        <input type="text" name="github_username" 
                               value="{{ github_username or 'Drew-CodeRGV' }}"
                               placeholder="Drew-CodeRGV" 
                               style="width: 100%; padding: 8px; border: 1px solid #ccc; font-size: 1rem;">
                    </div>
                    <small style="color: #666;">
                        Your GitHub username (not email address)
                    </small>
                </div>
                
                <!-- Repository Name -->
                <div style="margin-bottom: 25px; padding: 20px; border: 2px solid #333; background: #f8f8f8;">
                    <h4 style="margin: 0 0 15px 0;">
                        <i class="fas fa-code-branch"></i> Repository Name
                    </h4>
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px;">Repository:</label>
                        <input type="text" name="github_repo" 
                               value="{{ github_repo or 'TheWirelessMonitor' }}"
                               placeholder="TheWirelessMonitor" 
                               style="width: 100%; padding: 8px; border: 1px solid #ccc; font-size: 1rem;">
                    </div>
                    <small style="color: #666;">
                        Name of the repository to publish to (will be created if it doesn't exist)
                    </small>
                </div>
                
                <!-- Save Button -->
                <div style="text-align: center; margin: 30px 0; padding: 20px; border-top: 2px solid #000;">
                    <button type="submit" 
                            style="background: #000; color: white; border: none; padding: 15px 40px; font-size: 1.1rem; font-weight: bold; cursor: pointer;">
                        üíæ Save GitHub Configuration
                    </button>
                </div>
            </form>
        </article>
        
        <!-- Repository Management -->
        {% if github_token and github_username %}
        <article class="newspaper-article">
            <h3 class="article-headline">Repository Management</h3>
            <div class="article-byline">
                Create and manage your GitHub repository
            </div>
            
            <!-- Connection Status -->
            <div style="margin: 20px 0; padding: 15px; border: 2px solid {% if connection_status and connection_status.success %}#28a745{% else %}#dc3545{% endif %}; background: {% if connection_status and connection_status.success %}#d4edda{% else %}#f8d7da{% endif %};">
                {% if connection_status %}
                    {% if connection_status.success %}
                        <h4 style="color: #155724; margin: 0 0 10px 0;">‚úì GitHub Connection Successful</h4>
                        <p style="margin: 0; color: #155724;">
                            Connected as: <strong>{{ connection_status.username }}</strong><br>
                            Public Repos: {{ connection_status.public_repos }} ‚Ä¢ 
                            Private Repos: {{ connection_status.private_repos }}
                        </p>
                    {% else %}
                        <h4 style="color: #721c24; margin: 0 0 10px 0;">‚úó GitHub Connection Failed</h4>
                        <p style="margin: 0; color: #721c24;">
                            Error: {{ connection_status.error }}
                        </p>
                    {% endif %}
                {% else %}
                    <h4 style="color: #856404; margin: 0 0 10px 0;">‚ö† Connection Not Tested</h4>
                    <p style="margin: 0; color: #856404;">
                        Save your configuration to test the connection.
                    </p>
                {% endif %}
            </div>
            
            <!-- Repository Info -->
            {% if repo_info and repo_info.success %}
            <div style="margin: 20px 0; padding: 15px; border: 2px solid #17a2b8; background: #d1ecf1;">
                <h4 style="color: #0c5460; margin: 0 0 10px 0;">üìÅ Repository Information</h4>
                <div style="color: #0c5460;">
                    <strong>Name:</strong> {{ repo_info.name }}<br>
                    <strong>Description:</strong> {{ repo_info.description or 'No description' }}<br>
                    <strong>URL:</strong> <a href="{{ repo_info.url }}" target="_blank" style="color: #0c5460;">{{ repo_info.url }}</a><br>
                    <strong>Visibility:</strong> {{ 'Private' if repo_info.private else 'Public' }}<br>
                    <strong>Size:</strong> {{ repo_info.size }} KB<br>
                    <strong>Last Updated:</strong> {{ repo_info.updated_at[:10] }}
                </div>
            </div>
            {% endif %}
            
            <!-- Create Repository -->
            {% if not repo_info or not repo_info.success %}
            <div style="margin: 20px 0; padding: 20px; border: 2px dashed #666;">
                <h4>Create New Repository</h4>
                <form method="POST" action="{{ url_for('create_github_repo') }}">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px;">Repository Name:</label>
                        <input type="text" name="new_repo_name" 
                               value="{{ github_repo or 'TheWirelessMonitor' }}"
                               style="width: 100%; padding: 8px; border: 1px solid #ccc;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px;">Description:</label>
                        <input type="text" name="repo_description" 
                               value="The Wireless Monitor - RSS News Aggregator with AI Analysis"
                               style="width: 100%; padding: 8px; border: 1px solid #ccc;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px;">
                            <input type="checkbox" name="private_repo" style="margin-right: 8px;">
                            Make repository private
                        </label>
                    </div>
                    <button type="submit" 
                            style="background: #28a745; color: white; border: none; padding: 10px 20px; cursor: pointer;">
                        üèóÔ∏è Create Repository
                    </button>
                </form>
            </div>
            {% endif %}
            
            <!-- Publish Project -->
            {% if repo_info and repo_info.success %}
            <div style="margin: 30px 0; padding: 20px; border: 3px solid #000; background: #f5f5f5; text-align: center;">
                <h4>Publish Project to GitHub</h4>
                <p>This will upload all project files to your GitHub repository:</p>
                <ul style="text-align: left; display: inline-block; margin: 15px 0;">
                    <li>Source code (Python files)</li>
                    <li>Templates and static files</li>
                    <li>Configuration files</li>
                    <li>Installation scripts</li>
                    <li>Documentation</li>
                </ul>
                <form method="POST" action="{{ url_for('publish_to_github') }}" style="margin-top: 20px;">
                    <button type="submit" 
                            onclick="return confirm('This will upload all project files to GitHub. Continue?')"
                            style="background: #000; color: white; border: none; padding: 15px 30px; font-size: 1.1rem; font-weight: bold; cursor: pointer;">
                        üöÄ Publish to GitHub
                    </button>
                </form>
            </div>
            {% endif %}
        </article>
        {% endif %}
        
        <!-- GitHub Features -->
        <article class="newspaper-article">
            <h3 class="article-headline">GitHub Integration Features</h3>
            <div class="article-byline">
                What you can do with GitHub integration
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin: 20px 0;">
                <div>
                    <h4 style="border-bottom: 2px solid #000; padding-bottom: 5px;">Publishing Features</h4>
                    <ul style="list-style: none; padding: 0;">
                        <li>‚úì One-click project publishing</li>
                        <li>‚úì Automatic file synchronization</li>
                        <li>‚úì Version control integration</li>
                        <li>‚úì Commit history tracking</li>
                        <li>‚úì Repository management</li>
                    </ul>
                </div>
                <div>
                    <h4 style="border-bottom: 2px solid #000; padding-bottom: 5px;">Collaboration Features</h4>
                    <ul style="list-style: none; padding: 0;">
                        <li>‚úì Share with other developers</li>
                        <li>‚úì Issue tracking</li>
                        <li>‚úì Pull request workflow</li>
                        <li>‚úì Documentation hosting</li>
                        <li>‚úì Open source distribution</li>
                    </ul>
                </div>
            </div>
        </article>
    </div>
    
    <div class="sidebar">
        <!-- Quick Status -->
        <div class="sidebar-box">
            <div class="sidebar-header">GitHub Status</div>
            <div class="sidebar-content">
                <div class="sidebar-item">
                    <strong>Token:</strong><br>
                    {% if github_token %}
                        <span style="color: green;">‚úì Configured</span>
                    {% else %}
                        <span style="color: red;">‚úó Not Set</span>
                    {% endif %}
                </div>
                <div class="sidebar-item">
                    <strong>Username:</strong><br>
                    {% if github_username %}
                        <span style="color: green;">‚úì {{ github_username }}</span>
                    {% else %}
                        <span style="color: red;">‚úó Not Set</span>
                    {% endif %}
                </div>
                <div class="sidebar-item">
                    <strong>Repository:</strong><br>
                    {% if github_repo %}
                        <span style="color: green;">‚úì {{ github_repo }}</span>
                    {% else %}
                        <span style="color: orange;">‚ö† Default</span>
                    {% endif %}
                </div>
                <div class="sidebar-item">
                    <strong>Connection:</strong><br>
                    {% if connection_status %}
                        {% if connection_status.success %}
                            <span style="color: green;">‚úì Active</span>
                        {% else %}
                            <span style="color: red;">‚úó Failed</span>
                        {% endif %}
                    {% else %}
                        <span style="color: gray;">? Not Tested</span>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Recent Commits -->
        {% if commit_history and commit_history.success %}
        <div class="sidebar-box">
            <div class="sidebar-header">Recent Commits</div>
            <div class="sidebar-content">
                {% for commit in commit_history.commits[:5] %}
                <div class="sidebar-item">
                    <strong>{{ commit.sha }}</strong><br>
                    <small>{{ commit.message[:50] }}{% if commit.message|length > 50 %}...{% endif %}</small><br>
                    <small style="color: #666;">{{ commit.author }} ‚Ä¢ {{ commit.date[:10] }}</small>
                </div>
                {% endfor %}
                {% if github_username and github_repo %}
                <div style="text-align: center; margin-top: 10px;">
                    <a href="https://github.com/{{ github_username }}/{{ github_repo }}/commits" target="_blank" 
                       style="color: #000080; font-weight: bold;">¬ª View All Commits</a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Setup Guide -->
        <div class="sidebar-box">
            <div class="sidebar-header">Setup Guide</div>
            <div class="sidebar-content">
                <div class="sidebar-item">
                    <strong>1. Create Token:</strong><br>
                    <small>Visit GitHub Settings ‚Üí Developer settings ‚Üí Personal access tokens</small>
                </div>
                <div class="sidebar-item">
                    <strong>2. Set Permissions:</strong><br>
                    <small>Enable: repo, user, admin:repo_hook</small>
                </div>
                <div class="sidebar-item">
                    <strong>3. Configure:</strong><br>
                    <small>Enter token, username, and repository name</small>
                </div>
                <div class="sidebar-item">
                    <strong>4. Publish:</strong><br>
                    <small>Click "Publish to GitHub" to upload your project</small>
                </div>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="sidebar-box">
            <div class="sidebar-header">Admin Navigation</div>
            <div class="sidebar-content">
                <div class="sidebar-item">
                    <a href="{{ url_for('admin_console') }}">‚öôÔ∏è Admin Console</a>
                </div>
                <div class="sidebar-item">
                    <a href="{{ url_for('social_media_config') }}">üì± Social Media</a>
                </div>
                <div class="sidebar-item">
                    <a href="{{ url_for('manage_feeds') }}">üì° Manage Feeds</a>
                </div>
                <div class="sidebar-item">
                    <a href="{{ url_for('index') }}">üì∞ Front Page</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Test GitHub connection
async function testGitHubConnection() {
    try {
        const response = await fetch('/api/github/test_connection');
        const data = await response.json();
        
        if (data.success) {
            alert(`‚úì GitHub connection successful!\nConnected as: ${data.username}\nPublic repos: ${data.public_repos}`);
        } else {
            alert(`‚úó GitHub connection failed:\n${data.error}`);
        }
    } catch (error) {
        alert(`Connection test error: ${error.message}`);
    }
}

// Auto-test connection when page loads if configured
document.addEventListener('DOMContentLoaded', function() {
    const hasToken = {{ 'true' if github_token else 'false' }};
    const hasUsername = {{ 'true' if github_username else 'false' }};
    
    if (hasToken && hasUsername && !{{ 'true' if connection_status else 'false' }}) {
        // Auto-test connection if not already tested
        setTimeout(testGitHubConnection, 1000);
    }
});
</script>
{% endblock %}