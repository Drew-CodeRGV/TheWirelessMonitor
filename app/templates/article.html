{% extends "base.html" %}

{% block title %}{{ article.title }} - The Wireless Monitor{% endblock %}

{% block content %}
<div class="articles-grid">
    <div class="main-articles">
        <!-- Article Header -->
        <article class="newspaper-article">
            <h1 class="article-headline" style="font-size: 2.2rem; margin-bottom: 15px;">
                {{ article.title }}
            </h1>
            
            <div class="article-byline" style="font-size: 1rem; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #000;">
                <strong>Published:</strong> {{ moment(article.published_date).format('MMMM Do, YYYY') if article.published_date else 'Recent' }} ‚Ä¢ 
                <strong>Source:</strong> {{ article.feed_name or 'Unknown' }} ‚Ä¢ 
                <strong>Relevance:</strong> {{ "%.0f"|format(article.relevance_score * 100) }}%
                {% if article.entertainment_score and article.entertainment_score > 0.3 %}
                ‚Ä¢ <strong>Entertainment:</strong> {{ "%.0f"|format(article.entertainment_score * 100) }}%
                {% endif %}
            </div>
            
            <!-- Article Image -->
            {% if article.image_url %}
            <div style="text-align: center; margin: 25px 0;">
                <img src="{{ article.image_url }}" alt="Article image" 
                     style="max-width: 100%; height: auto; border: 2px solid #000; box-shadow: 3px 3px 0px #ccc;">
                <div style="font-size: 0.9rem; color: #666; margin-top: 8px; font-style: italic;">
                    Image related to: {{ article.title }}
                </div>
            </div>
            {% endif %}
            
            <!-- Article Content -->
            <div class="article-text" style="font-size: 1.1rem; line-height: 1.6; text-align: justify; margin: 25px 0;">
                {% if article.content and article.content.strip() %}
                    {{ article.content|replace('\n', '<br>')|safe }}
                {% else %}
                    {{ article.description|replace('\n', '<br>')|safe }}
                    
                    <div style="margin: 30px 0; padding: 20px; border: 2px dashed #666; background: #f9f9f9; text-align: center;">
                        <h4>Read the Complete Story</h4>
                        <p>This is a summary from our RSS feed. For the full article with all details, images, and analysis:</p>
                        <a href="{{ article.url }}" target="_blank" 
                           style="background: #000; color: white; padding: 12px 25px; text-decoration: none; font-weight: bold; display: inline-block; margin-top: 10px;">
                            ¬ª Read Full Article at Source
                        </a>
                    </div>
                {% endif %}
            </div>
            
            <!-- Keywords -->
            {% if article.wifi_keywords %}
            <div style="margin: 25px 0; padding: 15px; border-top: 2px solid #000;">
                <strong>Related Keywords:</strong>
                <div style="margin-top: 8px;">
                    {% for keyword in (article.wifi_keywords|from_json)[:10] %}
                    <span style="background: #f0f0f0; border: 1px solid #ccc; padding: 3px 8px; margin: 2px; display: inline-block; font-size: 0.9rem;">
                        {{ keyword }}
                    </span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Social Sharing -->
            <div style="margin: 30px 0; padding: 20px; border: 3px solid #000; background: #f5f5f5;">
                <h3 style="margin: 0 0 15px 0; font-size: 1.4rem;">Share This Story</h3>
                
                {% if social_config %}
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    {% for social in social_config %}
                    <button onclick="shareArticle('{{ social.platform }}', {{ article.id }})" 
                            style="background: {% if social.platform == 'twitter' %}#1DA1F2{% elif social.platform == 'linkedin' %}#0077B5{% elif social.platform == 'instagram' %}#E4405F{% elif social.platform == 'facebook' %}#1877F2{% else %}#000{% endif %}; 
                                   color: white; border: none; padding: 12px; cursor: pointer; font-weight: bold; text-align: center;">
                        <i class="fab fa-{{ social.platform }}"></i> 
                        Share on {{ social.display_name }}
                        {% if social.handle %}
                        <br><small>@{{ social.handle }}</small>
                        {% endif %}
                    </button>
                    {% endfor %}
                </div>
                {% else %}
                <p style="color: #666; font-style: italic;">
                    Social media sharing not configured. 
                    <a href="{{ url_for('social_media_config') }}" style="color: #000080;">Configure in Admin</a>
                </p>
                {% endif %}
                
                <!-- Direct Link Sharing -->
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ccc;">
                    <strong>Direct Link:</strong>
                    <div style="display: flex; margin-top: 8px;">
                        <input type="text" id="articleUrl" value="{{ request.url }}" readonly 
                               style="flex: 1; padding: 8px; border: 1px solid #ccc; font-family: monospace;">
                        <button onclick="copyArticleUrl()" 
                                style="background: #000; color: white; border: none; padding: 8px 15px; cursor: pointer; margin-left: 5px;">
                            Copy Link
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Navigation -->
            <div style="margin: 30px 0; text-align: center; padding: 20px; border-top: 2px solid #000;">
                <a href="{{ url_for('index') }}" 
                   style="background: #000; color: white; padding: 12px 25px; text-decoration: none; font-weight: bold; margin: 0 10px;">
                    ¬´ Back to Front Page
                </a>
                <a href="{{ article.url }}" target="_blank"
                   style="background: #8B0000; color: white; padding: 12px 25px; text-decoration: none; font-weight: bold; margin: 0 10px;">
                    Read Original Source ¬ª
                </a>
            </div>
        </article>
    </div>
    
    <!-- Sidebar -->
    <div class="sidebar">
        <!-- Article Stats -->
        <div class="sidebar-box">
            <div class="sidebar-header">Article Information</div>
            <div class="sidebar-content">
                <div class="sidebar-item">
                    <strong>Relevance Score:</strong><br>
                    {{ "%.0f"|format(article.relevance_score * 100) }}% Wireless Related
                </div>
                {% if article.entertainment_score and article.entertainment_score > 0.1 %}
                <div class="sidebar-item">
                    <strong>Entertainment Value:</strong><br>
                    {{ "%.0f"|format(article.entertainment_score * 100) }}% Fun Factor
                </div>
                {% endif %}
                <div class="sidebar-item">
                    <strong>Published:</strong><br>
                    {{ moment(article.published_date).fromNow() if article.published_date else 'Recent' }}
                </div>
                <div class="sidebar-item">
                    <strong>Source Feed:</strong><br>
                    {{ article.feed_name or 'Unknown Source' }}
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="sidebar-box">
            <div class="sidebar-header">Quick Actions</div>
            <div class="sidebar-content">
                <div class="sidebar-item">
                    <a href="{{ article.url }}" target="_blank">üîó Original Source</a>
                </div>
                <div class="sidebar-item">
                    <a href="#" onclick="window.print(); return false;">üñ®Ô∏è Print Article</a>
                </div>
                <div class="sidebar-item">
                    <a href="mailto:?subject={{ article.title|urlencode }}&body=Check out this wireless tech story: {{ request.url|urlencode }}">üìß Email Article</a>
                </div>
                <div class="sidebar-item">
                    <a href="{{ url_for('entertainment_stories') }}">üòÑ More Fun Stories</a>
                </div>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="sidebar-box">
            <div class="sidebar-header">Navigation</div>
            <div class="sidebar-content">
                <div class="sidebar-item">
                    <a href="{{ url_for('index') }}">üì∞ Front Page</a>
                </div>
                <div class="sidebar-item">
                    <a href="{{ url_for('weekly_digest') }}">üìÖ Weekly Review</a>
                </div>
                <div class="sidebar-item">
                    <a href="{{ url_for('podcast_script') }}">üéôÔ∏è Podcast Scripts</a>
                </div>
                <div class="sidebar-item">
                    <a href="{{ url_for('admin_console') }}">‚öôÔ∏è Admin Desk</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Modal for Instagram -->
<div id="shareModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border: 3px solid #000; max-width: 500px; width: 90%;">
        <h3 style="margin: 0 0 15px 0;">Share on <span id="modalPlatform"></span></h3>
        <div id="modalContent"></div>
        <button onclick="closeShareModal()" style="background: #000; color: white; border: none; padding: 10px 20px; cursor: pointer; margin-top: 15px; float: right;">
            Close
        </button>
        <div style="clear: both;"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function moment(date) {
    if (!date) return { 
        fromNow: () => 'Recent',
        format: (fmt) => 'Recent'
    };
    
    const d = new Date(date);
    const now = new Date();
    const diffMs = now - d;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    return {
        fromNow: function() {
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min ago`;
            if (diffHours < 24) return `${diffHours} hr ago`;
            if (diffDays < 7) return `${diffDays} days ago`;
            return d.toLocaleDateString();
        },
        format: function(fmt) {
            if (fmt === 'MMMM Do, YYYY') {
                const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];
                const day = d.getDate();
                const suffix = day === 1 || day === 21 || day === 31 ? 'st' :
                             day === 2 || day === 22 ? 'nd' :
                             day === 3 || day === 23 ? 'rd' : 'th';
                return `${months[d.getMonth()]} ${day}${suffix}, ${d.getFullYear()}`;
            }
            return d.toLocaleDateString();
        }
    };
}

async function shareArticle(platform, articleId) {
    try {
        const response = await fetch(`/api/share/${articleId}/${platform}`);
        const data = await response.json();
        
        if (data.error) {
            alert(`Error: ${data.error}`);
            return;
        }
        
        if (platform === 'instagram') {
            // Show modal with copy text for Instagram
            document.getElementById('modalPlatform').textContent = 'Instagram';
            document.getElementById('modalContent').innerHTML = `
                <p><strong>Instagram doesn't support direct link sharing. Copy this text and paste it into your Instagram post:</strong></p>
                <textarea readonly style="width: 100%; height: 150px; padding: 10px; border: 1px solid #ccc; font-family: monospace;">${data.copy_text}</textarea>
                <button onclick="copyInstagramText()" style="background: #E4405F; color: white; border: none; padding: 8px 15px; cursor: pointer; margin-top: 10px;">
                    Copy Text
                </button>
                <p><strong>Suggested Image:</strong> <a href="${data.image}" target="_blank">Download Article Image</a></p>
            `;
            document.getElementById('shareModal').style.display = 'block';
        } else if (data.share_url) {
            // Open share URL in new window
            window.open(data.share_url, '_blank', 'width=600,height=400');
        }
        
    } catch (error) {
        alert(`Sharing error: ${error.message}`);
    }
}

function copyInstagramText() {
    const textarea = document.querySelector('#modalContent textarea');
    textarea.select();
    document.execCommand('copy');
    alert('Instagram text copied to clipboard!');
}

function copyArticleUrl() {
    const urlInput = document.getElementById('articleUrl');
    urlInput.select();
    document.execCommand('copy');
    alert('Article URL copied to clipboard!');
}

function closeShareModal() {
    document.getElementById('shareModal').style.display = 'none';
}

// Close modal when clicking outside
document.getElementById('shareModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeShareModal();
    }
});
</script>
{% endblock %}