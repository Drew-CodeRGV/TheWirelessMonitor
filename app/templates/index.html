{% extends "base.html" %}

{% block title %}The Wireless Monitor - Today's Headlines{% endblock %}

{% block content %}
{% if view_mode == 'reader' %}
    <!-- Google Reader Style Three-Pane Layout -->
    <div class="reader-layout">
        <!-- Feeds Pane -->
        <div class="feeds-pane">
            <h3>üì° RSS Feeds</h3>
            <ul class="feed-list">
                <li class="feed-item active">All Items ({{ total_articles }})</li>
                <li class="feed-item">Starred Items</li>
                <li class="feed-item">Shared Items</li>
                <li class="feed-item">---</li>
                <li class="feed-item">Ars Technica</li>
                <li class="feed-item">TechCrunch</li>
                <li class="feed-item">The Verge</li>
                <li class="feed-item">IEEE Spectrum</li>
                <li class="feed-item">Fierce Wireless</li>
                <li class="feed-item">RCR Wireless</li>
            </ul>
        </div>
        
        <!-- Articles List Pane -->
        <div class="articles-pane">
            <h3>üì∞ Headlines ({{ stories|length }})</h3>
            {% if stories %}
                {% for story in stories %}
                <div class="article-list-item" onclick="selectArticle({{ loop.index0 }})">
                    <h4>{{ story.title }}</h4>
                    <div class="snippet">{{ (story.description[:120] + '...') if story.description and story.description|length > 120 else (story.description or 'No preview available') }}</div>
                    <div class="meta">
                        <span>{{ story.feed_name }}</span>
                        <span>{{ story.published_date[:10] }}</span>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div style="padding: 40px 20px; text-align: center; color: #666;">
                    <p>No articles available</p>
                    <button onclick="fetchNow()" class="btn">üîÑ Fetch Now</button>
                </div>
            {% endif %}
        </div>
        
        <!-- Article Preview Pane -->
        <div class="article-preview">
            <div id="article-content">
                <h2>Select an article to preview</h2>
                <p style="color: #666; margin-top: 20px;">Click on any article from the list to see its full content here.</p>
            </div>
        </div>
    </div>
    
    <script>
        const articles = {{ stories|tojson }};
        
        function selectArticle(index) {
            // Remove previous selection
            document.querySelectorAll('.article-list-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selection to clicked item
            document.querySelectorAll('.article-list-item')[index].classList.add('selected');
            
            // Update preview pane
            const article = articles[index];
            const previewPane = document.getElementById('article-content');
            
            previewPane.innerHTML = `
                <h2>${article.title}</h2>
                <div class="preview-meta">
                    <strong>Source:</strong> ${article.feed_name} | 
                    <strong>Published:</strong> ${article.published_date.substring(0, 16)} | 
                    <strong>Relevance:</strong> ${Math.round(article.relevance_score * 100)}%
                </div>
                <div class="content">
                    ${article.content || article.description || 'No content available'}
                    <br><br>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="shareArticle(${article.id})" class="btn" style="background: #1da1f2; font-size: 0.85rem; padding: 6px 12px;">
                            üì§ Share
                        </button>
                        <button onclick="addToDigest(${article.id})" class="btn" style="background: #ff6b35; font-size: 0.85rem; padding: 6px 12px;">
                            üìã Add to Digest
                        </button>
                        <a href="${article.url}" target="_blank" class="btn">üìñ Read Full Article</a>
                    </div>
                </div>
            `;
        }
        
        async function fetchNow() {
            const button = event.target;
            button.disabled = true;
            button.textContent = '‚è≥ Fetching...';
            
            try {
                const response = await fetch('/api/fetch_now');
                const data = await response.json();
                
                if (data.success) {
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Network error: ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = 'üîÑ Fetch Now';
            }
        }
    </script>

{% else %}
    <!-- NY Magazine Style Newspaper Layout -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 35px;">
        <h2>üì∞ Today's Wireless Technology Headlines</h2>
        <div style="display: flex; gap: 10px;">
            {% if not show_all and total_articles > (stories|length) %}
                <a href="{{ url_for('index', view=view_mode, show_all='true') }}" class="btn" style="background: #27ae60;">üìã Show All ({{ total_articles }})</a>
            {% elif show_all %}
                <a href="{{ url_for('index', view=view_mode) }}" class="btn" style="background: #f39c12;">üéØ Show Relevant Only</a>
            {% endif %}
            <button onclick="fetchNow()" class="btn">üîÑ Fetch Now</button>
        </div>
    </div>

    {% if show_all and stories %}
    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #f39c12;">
        <p style="font-family: 'Inter', sans-serif; font-size: 0.9rem; color: #856404; margin: 0;">
            <strong>üìã Showing all {{ stories|length }} articles</strong> - including low relevance items. 
            <a href="{{ url_for('index', view=view_mode) }}" style="color: #856404; text-decoration: underline;">Show relevant only</a>
        </p>
    </div>
    {% endif %}

    <div id="fetch-status" style="margin-bottom: 25px;"></div>

    {% if stories %}
        <!-- NY Magazine Style Grid Layout -->
        <div class="articles-grid">
            <!-- Featured Article (First high-relevance article) -->
            {% set featured_article = stories[0] %}
            <article class="featured-article">
                <!-- Article Image -->
                <div class="article-image" style="margin-bottom: 15px;">
                    {% if featured_article.image_url %}
                        <img src="{{ featured_article.image_url }}" alt="{{ featured_article.title }}" 
                             style="width: 100%; height: 250px; object-fit: cover; border-radius: 8px;">
                    {% else %}
                        <div class="image-placeholder" style="width: 100%; height: 250px; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-direction: column; cursor: pointer;" 
                             onclick="generateArticleImage({{ featured_article.id }}, this)">
                            <div style="text-align: center; color: #6c757d;">
                                <div style="font-size: 2rem; margin-bottom: 10px;">üé®</div>
                                <div style="font-family: 'Inter', sans-serif; font-size: 0.9rem; font-weight: 500;">Creating visualization...</div>
                                <div style="font-family: 'Inter', sans-serif; font-size: 0.8rem; margin-top: 5px;">Click to generate AI image</div>
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <div class="article-meta">
                    {% set icon, color = get_feed_icon(featured_article.feed_name, featured_article.feed_url) %}
                    <span class="feed-source" style="border-color: {{ color }};">
                        <span style="color: {{ color }};">{{ icon }}</span>
                        {{ featured_article.feed_name }}
                    </span>
                    <span>{{ featured_article.published_date[:16] }}</span>
                    <span class="relevance-score" style="{% if featured_article.relevance_score < 0.3 %}background: #e74c3c;{% elif featured_article.relevance_score < 0.6 %}background: #f39c12;{% else %}background: #27ae60;{% endif %}">
                        {{ "%.0f"|format(featured_article.relevance_score * 100) }}% Relevant
                    </span>
                </div>
                <h3><a href="{{ featured_article.url }}" target="_blank">{{ featured_article.title }}</a></h3>
                {% if featured_article.content and featured_article.content|length > 100 %}
                    <p>{{ featured_article.content[:300] }}{% if featured_article.content|length > 300 %}...{% endif %}</p>
                {% elif featured_article.description %}
                    <p>{{ featured_article.description[:250] }}{% if featured_article.description|length > 250 %}...{% endif %}</p>
                {% else %}
                    <p style="color: #7f8c8d; font-style: italic;">No content preview available</p>
                {% endif %}
                
                <!-- Social sharing and digest buttons -->
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button onclick="shareArticle({{ featured_article.id }})" class="btn" style="background: #1da1f2; font-size: 0.85rem; padding: 8px 16px;">
                        üì§ Share
                    </button>
                    <button onclick="addToDigest({{ featured_article.id }})" class="btn" style="background: #ff6b35; font-size: 0.85rem; padding: 8px 16px;">
                        üìã Add to Digest
                    </button>
                </div>
            </article>
            
            <!-- Secondary Articles Column 1 -->
            <div class="secondary-articles">
                {% for story in stories[1:4] %}
                <article class="article-card">
                    <div class="article-meta">
                        {% set icon, color = get_feed_icon(story.feed_name, story.feed_url) %}
                        <span class="feed-source" style="border-color: {{ color }};">
                            <span style="color: {{ color }};">{{ icon }}</span>
                            {{ story.feed_name }}
                        </span>
                        <span>{{ story.published_date[:10] }}</span>
                        <span class="relevance-score" style="{% if story.relevance_score < 0.3 %}background: #e74c3c;{% elif story.relevance_score < 0.6 %}background: #f39c12;{% else %}background: #27ae60;{% endif %}">
                            {{ "%.0f"|format(story.relevance_score * 100) }}%
                        </span>
                    </div>
                    <h3><a href="{{ story.url }}" target="_blank">{{ story.title }}</a></h3>
                    {% if story.description %}
                        <p>{{ story.description[:150] }}{% if story.description|length > 150 %}...{% endif %}</p>
                    {% endif %}
                    
                    <!-- Social sharing and digest buttons -->
                    <div style="margin-top: 10px; display: flex; gap: 8px;">
                        <button onclick="shareArticle({{ story.id }})" class="btn" style="background: #1da1f2; font-size: 0.75rem; padding: 6px 12px;">
                            üì§ Share
                        </button>
                        <button onclick="addToDigest({{ story.id }})" class="btn" style="background: #ff6b35; font-size: 0.75rem; padding: 6px 12px;">
                            üìã Digest
                        </button>
                    </div>
                </article>
                {% endfor %}
            </div>
            
            <!-- Secondary Articles Column 2 -->
            <div class="secondary-articles">
                {% for story in stories[4:7] %}
                <article class="article-card">
                    <div class="article-meta">
                        {% set icon, color = get_feed_icon(story.feed_name, story.feed_url) %}
                        <span class="feed-source" style="border-color: {{ color }};">
                            <span style="color: {{ color }};">{{ icon }}</span>
                            {{ story.feed_name }}
                        </span>
                        <span>{{ story.published_date[:10] }}</span>
                        <span class="relevance-score" style="{% if story.relevance_score < 0.3 %}background: #e74c3c;{% elif story.relevance_score < 0.6 %}background: #f39c12;{% else %}background: #27ae60;{% endif %}">
                            {{ "%.0f"|format(story.relevance_score * 100) }}%
                        </span>
                    </div>
                    <h3><a href="{{ story.url }}" target="_blank">{{ story.title }}</a></h3>
                    {% if story.description %}
                        <p>{{ story.description[:150] }}{% if story.description|length > 150 %}...{% endif %}</p>
                    {% endif %}
                    
                    <!-- Social sharing and digest buttons -->
                    <div style="margin-top: 10px; display: flex; gap: 8px;">
                        <button onclick="shareArticle({{ story.id }})" class="btn" style="background: #1da1f2; font-size: 0.75rem; padding: 6px 12px;">
                            üì§ Share
                        </button>
                        <button onclick="addToDigest({{ story.id }})" class="btn" style="background: #ff6b35; font-size: 0.75rem; padding: 6px 12px;">
                            üìã Digest
                        </button>
                    </div>
                </article>
                {% endfor %}
            </div>
        </div>
        
        <!-- Additional Articles (if showing all) -->
        {% if stories|length > 7 %}
        <div style="margin-top: 40px; padding-top: 30px; border-top: 2px solid #e1e5e9;">
            <h3 style="font-family: 'Playfair Display', serif; font-size: 1.8rem; margin-bottom: 25px; color: #000;">More Stories</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px;">
                {% for story in stories[7:] %}
                <article class="article-card">
                    <div class="article-meta">
                        {% set icon, color = get_feed_icon(story.feed_name, story.feed_url) %}
                        <span class="feed-source" style="border-color: {{ color }};">
                            <span style="color: {{ color }};">{{ icon }}</span>
                            {{ story.feed_name }}
                        </span>
                        <span>{{ story.published_date[:10] }}</span>
                        <span class="relevance-score" style="{% if story.relevance_score < 0.3 %}background: #e74c3c;{% elif story.relevance_score < 0.6 %}background: #f39c12;{% else %}background: #27ae60;{% endif %}">
                            {{ "%.0f"|format(story.relevance_score * 100) }}%
                        </span>
                        {% if story.relevance_score < 0.3 %}
                            <span style="font-size: 0.7rem; color: #e74c3c;">‚ö†Ô∏è Low</span>
                        {% endif %}
                    </div>
                    <h3><a href="{{ story.url }}" target="_blank">{{ story.title }}</a></h3>
                    {% if story.description %}
                        <p>{{ story.description[:200] }}{% if story.description|length > 200 %}...{% endif %}</p>
                    {% endif %}
                    
                    {% if show_all and story.relevance_score < 0.5 %}
                    <div style="font-size: 0.8rem; color: #7f8c8d; margin-top: 8px; font-family: 'Inter', sans-serif;">
                        <strong>Why low relevance?</strong> 
                        {% if story.wifi_keywords %}
                            Found keywords: {{ story.wifi_keywords }}
                        {% elif story.relevance_score < 0.1 %}
                            No wireless technology keywords found.
                        {% elif story.relevance_score < 0.3 %}
                            Few wireless technology keywords detected.
                        {% else %}
                            Some wireless keywords found but not highly relevant.
                        {% endif %}
                    </div>
                    {% endif %}
                </article>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
    {% else %}
        <div style="text-align: center; padding: 60px 20px; color: #7f8c8d; background: #f8f9fa; border-radius: 10px; border: 2px dashed #dee2e6;">
            <h3 style="font-family: 'Inter', sans-serif; font-size: 2rem; margin-bottom: 15px; color: #2c3e50;">üì° No Stories Available</h3>
            <p style="font-family: 'Inter', sans-serif; font-size: 1.1rem; margin-bottom: 25px;">
                {% if total_articles > 0 %}
                    Found {{ total_articles }} articles but none meet the relevance threshold. 
                    <a href="{{ url_for('index', view=view_mode, show_all='true') }}" style="color: #2980b9; text-decoration: underline;">Show all articles</a>
                {% else %}
                    Click "Fetch Now" to get the latest wireless technology news from your RSS feeds
                {% endif %}
            </p>
            <button onclick="fetchNow()" class="btn" style="font-size: 1.1rem; padding: 15px 30px;">üîÑ Fetch RSS Feeds</button>
        </div>
    {% endif %}

    <!-- Social Sharing Popup -->
    <div id="shareModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%;">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">üì§ Share Article</h3>
            <div id="socialPlatforms" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <!-- Platforms will be loaded here -->
            </div>
            <div style="text-align: center;">
                <button onclick="closeShareModal()" class="btn" style="background: #6c757d;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
    let currentArticleId = null;

    async function shareArticle(articleId) {
        currentArticleId = articleId;
        
        try {
            // Get available social platforms
            const response = await fetch('/api/get_social_config');
            const data = await response.json();
            
            if (data.success && data.platforms.length > 0) {
                const platformsDiv = document.getElementById('socialPlatforms');
                platformsDiv.innerHTML = '';
                
                data.platforms.forEach(platform => {
                    const platformButton = document.createElement('button');
                    platformButton.className = 'btn';
                    platformButton.style.cssText = 'width: 100%; padding: 15px 10px; font-size: 0.9rem;';
                    
                    // Platform-specific styling
                    if (platform.platform === 'Twitter') {
                        platformButton.style.background = '#1da1f2';
                        platformButton.innerHTML = 'üê¶<br>Twitter';
                    } else if (platform.platform === 'LinkedIn') {
                        platformButton.style.background = '#0077b5';
                        platformButton.innerHTML = 'üíº<br>LinkedIn';
                    } else if (platform.platform === 'Facebook') {
                        platformButton.style.background = '#1877f2';
                        platformButton.innerHTML = 'üìò<br>Facebook';
                    } else if (platform.platform === 'Mastodon') {
                        platformButton.style.background = '#6364ff';
                        platformButton.innerHTML = 'üêò<br>Mastodon';
                    } else {
                        platformButton.style.background = '#28a745';
                        platformButton.innerHTML = `üì±<br>${platform.platform}`;
                    }
                    
                    platformButton.onclick = () => shareToSocial(platform.platform);
                    platformsDiv.appendChild(platformButton);
                });
                
                document.getElementById('shareModal').style.display = 'block';
            } else {
                alert('No social media platforms configured. Please configure them in the admin panel.');
            }
        } catch (error) {
            alert('Error loading social platforms: ' + error.message);
        }
    }

    async function shareToSocial(platform) {
        try {
            const response = await fetch('/api/share_article', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    article_id: currentArticleId,
                    platform: platform
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Open sharing window
                window.open(data.share_content.share_url, '_blank', 'width=600,height=400');
                closeShareModal();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Network error: ' + error.message);
        }
    }

    async function addToDigest(articleId) {
        const notes = prompt('Add notes for this article (optional):');
        if (notes === null) return; // User cancelled
        
        try {
            const response = await fetch('/api/add_to_digest', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    article_id: articleId,
                    notes: notes
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('‚úÖ Article added to weekly digest!');
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Network error: ' + error.message);
        }
    }

    function closeShareModal() {
        document.getElementById('shareModal').style.display = 'none';
        currentArticleId = null;
    }

    // Close modal when clicking outside
    document.getElementById('shareModal').onclick = function(e) {
        if (e.target === this) {
            closeShareModal();
        }
    }

    async function generateArticleImage(articleId, placeholderElement) {
        // Update placeholder to show loading state
        placeholderElement.innerHTML = `
            <div style="text-align: center; color: #6c757d;">
                <div style="font-size: 2rem; margin-bottom: 10px;">‚è≥</div>
                <div style="font-family: 'Inter', sans-serif; font-size: 0.9rem; font-weight: 500;">Generating image...</div>
                <div style="font-family: 'Inter', sans-serif; font-size: 0.8rem; margin-top: 5px;">Please wait</div>
            </div>
        `;
        
        try {
            const response = await fetch(`/api/generate_article_image/${articleId}`, {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Replace placeholder with generated image
                placeholderElement.outerHTML = `
                    <img src="${data.image_url}" alt="Generated visualization" 
                         style="width: 100%; height: 250px; object-fit: cover; border-radius: 8px;">
                `;
            } else {
                // Show error state
                placeholderElement.innerHTML = `
                    <div style="text-align: center; color: #dc3545;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">‚ùå</div>
                        <div style="font-family: 'Inter', sans-serif; font-size: 0.9rem; font-weight: 500;">Generation failed</div>
                        <div style="font-family: 'Inter', sans-serif; font-size: 0.8rem; margin-top: 5px;">Click to retry</div>
                    </div>
                `;
            }
        } catch (error) {
            // Show error state
            placeholderElement.innerHTML = `
                <div style="text-align: center; color: #dc3545;">
                    <div style="font-size: 2rem; margin-bottom: 10px;">‚ùå</div>
                    <div style="font-family: 'Inter', sans-serif; font-size: 0.9rem; font-weight: 500;">Network error</div>
                    <div style="font-family: 'Inter', sans-serif; font-size: 0.8rem; margin-top: 5px;">Click to retry</div>
                </div>
            `;
        }
    }

    <script>
    async function fetchNow() {
        const statusDiv = document.getElementById('fetch-status');
        const button = event.target;
        
        button.disabled = true;
        button.textContent = '‚è≥ Fetching...';
        statusDiv.innerHTML = '<div class="alert alert-success">üì° Fetching RSS feeds, please wait...</div>';
        
        try {
            const response = await fetch('/api/fetch_now');
            const data = await response.json();
            
            if (data.success) {
                statusDiv.innerHTML = `<div class="alert alert-success">‚úÖ Successfully fetched ${data.fetched} new articles! Refreshing page...</div>`;
                setTimeout(() => location.reload(), 2000);
            } else {
                statusDiv.innerHTML = `<div class="alert alert-error">‚ùå Error: ${data.error}</div>`;
            }
        } catch (error) {
            statusDiv.innerHTML = `<div class="alert alert-error">‚ùå Network error: ${error.message}</div>`;
        } finally {
            button.disabled = false;
            button.textContent = 'üîÑ Fetch Now';
        }
    }
    </script>
{% endif %}
{% endblock %}