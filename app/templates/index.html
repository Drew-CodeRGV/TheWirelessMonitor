{% extends "base.html" %}

{% block title %}The Wireless Monitor - Today's Headlines{% endblock %}

{% block content %}
{% if view_mode == 'reader' %}
    <!-- Reader mode content (keeping existing) -->
    <div class="reader-layout">
        <!-- Feeds Pane -->
        <div class="feeds-pane">
            <h3>üì° RSS Feeds</h3>
            <ul class="feed-list">
                <li class="feed-item active">All Items ({{ total_articles }})</li>
                <li class="feed-item">Starred Items</li>
                <li class="feed-item">Shared Items</li>
            </ul>
        </div>
        
        <!-- Articles List Pane -->
        <div class="articles-pane">
            <h3>üì∞ Headlines ({{ stories|length }})</h3>
            {% if stories %}
                {% for story in stories %}
                <div class="article-list-item" onclick="selectArticle({{ loop.index0 }})">
                    <h4>{{ story.title }}</h4>
                    <div class="snippet">{{ (story.description[:120] + '...') if story.description and story.description|length > 120 else (story.description or 'No preview available') }}</div>
                    <div class="meta">
                        <span>{{ story.feed_name }}</span>
                        <span>{{ story.published_date[:10] }}</span>
                    </div>
                </div>
                {% endfor %}
            {% endif %}
        </div>
        
        <!-- Article Preview Pane -->
        <div class="article-preview">
            <div id="article-content">
                <h2>Select an article to preview</h2>
            </div>
        </div>
    </div>

{% else %}
    <!-- NEWSPAPER MODE - Al Jazeera Style Layout -->
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 35px;">
        <h2>üì∞ Latest Wireless Technology Headlines</h2>
        <div style="display: flex; gap: 10px;">
            {% if not show_all and total_articles > relevant_articles %}
                <a href="{{ url_for('index', view=view_mode, show_all='true') }}" class="btn" style="background: #27ae60;">üìã Show All ({{ total_articles }})</a>
            {% elif show_all %}
                <a href="{{ url_for('index', view=view_mode) }}" class="btn" style="background: #f39c12;">üéØ Show Relevant Only ({{ relevant_articles }})</a>
            {% elif total_articles > relevant_articles %}
                <a href="{{ url_for('index', view=view_mode, show_all='true') }}" class="btn" style="background: #27ae60;">üìã Show All ({{ total_articles }})</a>
            {% endif %}
            <button onclick="fetchNow()" class="btn">üîÑ Fetch Now</button>
        </div>
    </div>

    {% if show_all and stories %}
    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #f39c12;">
        <p style="font-family: 'Inter', sans-serif; font-size: 0.9rem; color: #856404; margin: 0;">
            <strong>üìã Showing all {{ stories|length }} articles from the last 7 days</strong> - including lower relevance items. 
            <a href="{{ url_for('index', view=view_mode) }}" style="color: #856404; text-decoration: underline;">Show relevant only ({{ relevant_articles }})</a>
        </p>
    </div>
    {% elif not show_all and stories %}
    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #27ae60;">
        <p style="font-family: 'Inter', sans-serif; font-size: 0.9rem; color: #2d5a2d; margin: 0;">
            <strong>üéØ Showing {{ stories|length }} most relevant articles</strong> from the last 7 days. 
            {% if total_articles > relevant_articles %}
                <a href="{{ url_for('index', view=view_mode, show_all='true') }}" style="color: #2d5a2d; text-decoration: underline;">Show all {{ total_articles }} articles</a>
            {% endif %}
        </p>
    </div>
    {% endif %}

    {% if stories %}
        <!-- AL JAZEERA LAYOUT: Hero Left (50%) + Two Right Columns (25% each) -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 50px;">
            
            <!-- LEFT SIDE: Hero Stories (50%) -->
            <div>
                <!-- Main Hero Story -->
                {% if stories[0] %}
                <article style="margin-bottom: 40px;">
                    <div style="position: relative; margin-bottom: 20px;">
                        {% if stories[0].image_url %}
                            <img src="{{ stories[0].image_url }}" alt="{{ stories[0].title }}" 
                                 style="width: 100%; height: 350px; object-fit: cover; border-radius: 8px;">
                        {% else %}
                            <div data-article-id="{{ stories[0].id }}" style="width: 100%; height: 350px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 8px;" 
                                 onclick="generateArticleImage({{ stories[0].id }}, this)">
                                <span style="color: #666;">üì∏ Generate Image</span>
                            </div>
                        {% endif %}
                    </div>
                    <h1 style="font-size: 2rem; font-weight: bold; margin-bottom: 15px; line-height: 1.2;">
                        <a href="{{ stories[0].url }}" target="_blank" style="color: #000; text-decoration: none;">{{ stories[0].title }}</a>
                    </h1>
                    {% if stories[0].description %}
                        <p style="font-size: 1.1rem; color: #666; margin-bottom: 20px;">{{ stories[0].description[:200] }}...</p>
                    {% endif %}
                    <div style="display: flex; gap: 10px;">
                        <a href="{{ stories[0].url }}" target="_blank" class="btn">Read More</a>
                    </div>
                </article>
                {% endif %}

                <!-- Secondary Hero Story -->
                {% if stories[1] %}
                <article>
                    <div style="position: relative; margin-bottom: 15px;">
                        {% if stories[1].image_url %}
                            <img src="{{ stories[1].image_url }}" alt="{{ stories[1].title }}" 
                                 style="width: 100%; height: 250px; object-fit: cover; border-radius: 8px;">
                        {% else %}
                            <div data-article-id="{{ stories[1].id }}" style="width: 100%; height: 250px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 8px;" 
                                 onclick="generateArticleImage({{ stories[1].id }}, this)">
                                <span style="color: #666;">üì∏ Generate Image</span>
                            </div>
                        {% endif %}
                    </div>
                    <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 10px;">
                        <a href="{{ stories[1].url }}" target="_blank" style="color: #000; text-decoration: none;">{{ stories[1].title }}</a>
                    </h2>
                    {% if stories[1].description %}
                        <p style="color: #666; margin-bottom: 15px;">{{ stories[1].description[:150] }}...</p>
                    {% endif %}
                </article>
                {% endif %}
            </div>

            <!-- RIGHT SIDE: Two Columns (50% total = 25% each) -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                
                <!-- Right Column 1: Top News (Stories 2-7) -->
                <div>
                    <h3 style="font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; border-bottom: 2px solid #e52d27; padding-bottom: 8px;">Top News</h3>
                    {% for story in stories[2:8] %}
                        {% if not story.event_name %}
                        <article style="margin-bottom: 20px; padding-bottom: 15px; {% if not loop.last %}border-bottom: 1px solid #eee;{% endif %}">
                            {% if story.image_url %}
                                <img src="{{ story.image_url }}" alt="{{ story.title }}" 
                                     style="width: 100%; height: 80px; object-fit: cover; margin-bottom: 10px; border-radius: 4px;">
                            {% else %}
                                <div data-article-id="{{ story.id }}" style="width: 100%; height: 80px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 10px; border-radius: 4px;" 
                                     onclick="generateArticleImage({{ story.id }}, this)">
                                    <span style="color: #666; font-size: 0.8rem;">üì∏</span>
                                </div>
                            {% endif %}
                            <h4 style="font-size: 0.9rem; font-weight: 600; margin-bottom: 5px;">
                                <a href="{{ story.url }}" target="_blank" style="color: #000; text-decoration: none;">{{ story.title }}</a>
                            </h4>
                            <p style="font-size: 0.8rem; color: #666;">{{ story.feed_name }} ‚Ä¢ {{ story.published_date[:10] }}</p>
                        </article>
                        {% endif %}
                    {% endfor %}
                </div>

                <!-- Right Column 2: Latest News (Stories 8-12) -->
                <div>
                    <h3 style="font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; border-bottom: 2px solid #3498db; padding-bottom: 8px;">Latest News</h3>
                    {% for story in stories[8:13] %}
                        {% if not story.event_name %}
                        <article style="margin-bottom: 20px; padding-bottom: 15px; {% if not loop.last %}border-bottom: 1px solid #eee;{% endif %}">
                            {% if story.image_url %}
                                <img src="{{ story.image_url }}" alt="{{ story.title }}" 
                                     style="width: 100%; height: 80px; object-fit: cover; margin-bottom: 10px; border-radius: 4px;">
                            {% else %}
                                <div data-article-id="{{ story.id }}" style="width: 100%; height: 80px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 10px; border-radius: 4px;" 
                                     onclick="generateArticleImage({{ story.id }}, this)">
                                    <span style="color: #666; font-size: 0.8rem;">üì∏</span>
                                </div>
                            {% endif %}
                            <h4 style="font-size: 0.9rem; font-weight: 600; margin-bottom: 5px;">
                                <a href="{{ story.url }}" target="_blank" style="color: #000; text-decoration: none;">{{ story.title }}</a>
                            </h4>
                            <p style="font-size: 0.8rem; color: #666;">{{ story.feed_name }} ‚Ä¢ {{ story.published_date[:10] }}</p>
                        </article>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- EVENT COVERAGE ROW - Full Width Bar Below Main Layout -->
        {% set event_articles = [] %}
        {% for story in stories %}
            {% if story.event_name %}
                {% set _ = event_articles.append(story) %}
            {% endif %}
        {% endfor %}
        
        {% if event_articles %}
        <div style="background: linear-gradient(135deg, #f8f4ff, #f0ebff); border: 2px solid #9c27b0; border-radius: 12px; padding: 30px; margin: 50px 0; width: 100%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="font-size: 2rem; color: #9c27b0; margin: 0;">üé™ Event Coverage</h2>
                <button onclick="refreshAllEvents()" class="btn" style="background: #9c27b0;">üîÑ Fetch Event News</button>
            </div>
            
            <!-- 4 Event Stories in a Row -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px;">
                {% for event_story in event_articles[:4] %}
                <article style="background: white; border-radius: 8px; padding: 20px; border: 1px solid #e1c7f7;">
                    {% if event_story.image_url %}
                        <img src="{{ event_story.image_url }}" alt="{{ event_story.title }}" 
                             style="width: 100%; height: 120px; object-fit: cover; border-radius: 6px; margin-bottom: 15px;">
                    {% else %}
                        <div data-article-id="{{ event_story.id }}" style="width: 100%; height: 120px; background: linear-gradient(135deg, #9c27b0, #8e24aa); border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 15px;" 
                             onclick="generateArticleImage({{ event_story.id }}, this)">
                            <span style="color: white;">üé™ Generate</span>
                        </div>
                    {% endif %}
                    
                    <div style="margin-bottom: 10px;">
                        <span style="background: #9c27b0; color: white; padding: 4px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: 600;">
                            {{ event_story.event_name }}
                        </span>
                    </div>
                    
                    <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 10px;">
                        <a href="{{ event_story.url }}" target="_blank" style="color: #2c3e50; text-decoration: none;">{{ event_story.title }}</a>
                    </h3>
                    
                    {% if event_story.description %}
                        <p style="font-size: 0.85rem; color: #666; margin-bottom: 15px;">{{ event_story.description[:100] }}...</p>
                    {% endif %}
                    
                    <div style="display: flex; gap: 8px;">
                        <a href="{{ event_story.url }}" target="_blank" class="btn" style="font-size: 0.8rem; padding: 6px 12px;">Read More</a>
                    </div>
                </article>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- MORE STORIES - Lower Relevance Stories -->
        {% set more_stories = [] %}
        {% for story in stories[13:] %}
            {% if not story.event_name %}
                {% set _ = more_stories.append(story) %}
            {% endif %}
        {% endfor %}
        
        {% if more_stories %}
        <div style="margin-top: 50px; padding-top: 30px; border-top: 2px solid #eee;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
                {% for story in more_stories %}
                <article style="border: 1px solid #eee; border-radius: 8px; padding: 20px;">
                    {% if story.image_url %}
                        <img src="{{ story.image_url }}" alt="{{ story.title }}" 
                             style="width: 100%; height: 150px; object-fit: cover; border-radius: 6px; margin-bottom: 15px;">
                    {% else %}
                        <div data-article-id="{{ story.id }}" style="width: 100%; height: 150px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 6px; margin-bottom: 15px;" 
                             onclick="generateArticleImage({{ story.id }}, this)">
                            <span style="color: #666;">üì∏ Generate Image</span>
                        </div>
                    {% endif %}
                    
                    <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 10px;">
                        <a href="{{ story.url }}" target="_blank" style="color: #000; text-decoration: none;">{{ story.title }}</a>
                    </h3>
                    
                    {% if story.description %}
                        <p style="color: #666; margin-bottom: 15px;">{{ story.description[:150] }}...</p>
                    {% endif %}
                    
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 0.8rem; color: #666;">{{ story.feed_name }} ‚Ä¢ {{ story.published_date[:10] }}</span>
                        <span style="background: #f39c12; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem;">
                            {{ "%.0f"|format(story.relevance_score * 100) }}%
                        </span>
                    </div>
                </article>
                {% endfor %}
            </div>
        </div>
        {% endif %}

    {% else %}
        <div style="text-align: center; padding: 60px 20px;">
            <h3>üì° No Stories Available</h3>
            <p>Click "Fetch Now" to get the latest wireless technology news</p>
            <button onclick="fetchNow()" class="btn">üîÑ Fetch RSS Feeds</button>
        </div>
    {% endif %}

    <script>
    async function generateArticleImage(articleId, placeholderElement) {
        placeholderElement.innerHTML = '<span style="color: #666;">‚è≥ Generating...</span>';
        
        try {
            const response = await fetch(`/api/generate_article_image/${articleId}`, {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.success) {
                placeholderElement.outerHTML = `
                    <img src="${data.image_url}" alt="Generated image" 
                         style="width: 100%; height: ${placeholderElement.style.height}; object-fit: cover; border-radius: 6px;">
                `;
            } else {
                placeholderElement.innerHTML = '<span style="color: #dc3545;">‚ùå Failed</span>';
            }
        } catch (error) {
            placeholderElement.innerHTML = '<span style="color: #dc3545;">‚ùå Error</span>';
        }
    }

    async function refreshAllEvents() {
        const button = event.target;
        button.disabled = true;
        button.textContent = '‚è≥ Fetching...';
        
        try {
            const response = await fetch('/api/refresh_all_events', { method: 'POST' });
            const data = await response.json();
            
            if (data.success) {
                button.textContent = `‚úÖ Found ${data.total_articles} articles!`;
                setTimeout(() => location.reload(), 2000);
            } else {
                button.textContent = '‚ùå Failed';
            }
        } catch (error) {
            button.textContent = '‚ùå Error';
        }
    }

    async function fetchNow() {
        const button = event.target;
        button.disabled = true;
        button.textContent = '‚è≥ Fetching...';
        
        try {
            const response = await fetch('/api/fetch_now');
            const data = await response.json();
            
            if (data.success) {
                setTimeout(() => location.reload(), 1000);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Network error: ' + error.message);
        } finally {
            button.disabled = false;
            button.textContent = 'üîÑ Fetch Now';
        }
    }
    </script>
{% endif %}
{% endblock %}