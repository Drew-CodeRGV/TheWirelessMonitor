{% extends "base.html" %}

{% block title %}Admin Dashboard - The Wireless Monitor{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto;">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white;">
        <div>
            <h1 style="font-family: 'Playfair Display', serif; font-size: 2.2rem; margin: 0; color: white;">âš™ï¸ Admin Dashboard</h1>
            <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 1rem;">System Management & Configuration</p>
        </div>
        <div style="text-align: right;">
            <div style="font-size: 0.9rem; opacity: 0.8;">Last Updated</div>
            <div style="font-size: 1.1rem; font-weight: 600;" id="current-time"></div>
        </div>
    </div>

    <!-- Quick Stats Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div class="stat-card" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
            <div class="stat-icon">ğŸ“°</div>
            <div class="stat-number">{{ stats.total_articles }}</div>
            <div class="stat-label">Total Articles</div>
        </div>
        
        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white;">
            <div class="stat-icon">ğŸ“¡</div>
            <div class="stat-number">{{ stats.active_feeds }}</div>
            <div class="stat-label">Active RSS Feeds</div>
        </div>
        
        <div class="stat-card" style="background: linear-gradient(135deg, #4facfe, #00f2fe); color: white;">
            <div class="stat-icon">ğŸ“…</div>
            <div class="stat-number">{{ stats.articles_today }}</div>
            <div class="stat-label">Articles Today</div>
        </div>
        
        <div class="stat-card" style="background: linear-gradient(135deg, #43e97b, #38f9d7); color: white;">
            <div class="stat-icon">ğŸª</div>
            <div class="stat-number">{{ stats.get('total_events', 0) }}</div>
            <div class="stat-label">Active Events</div>
        </div>
        
        <div class="stat-card" style="background: linear-gradient(135deg, #fa709a, #fee140); color: white;">
            <div class="stat-icon">ğŸŒ¿</div>
            <div class="stat-number">{{ stats.get('total_wild_stories', 0) }}</div>
            <div class="stat-label">Wild Wi-Fi Stories</div>
        </div>
        
        <a href="{{ url_for('image_gallery', view=view_mode) }}" class="stat-card" style="background: linear-gradient(135deg, #a8edea, #fed6e3); color: #333; text-decoration: none; display: block;">
            <div class="stat-icon">ğŸ–¼ï¸</div>
            <div class="stat-number">{{ stats.get('generated_images', 0) }}</div>
            <div class="stat-label">Generated Images</div>
            <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.7;">Click to view gallery â†’</div>
        </a>
    </div>

    <!-- Main Dashboard Grid -->
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
        <!-- Left Column -->
        <div>
            <!-- System Status -->
            <div class="admin-section">
                <h3>ğŸ–¥ï¸ System Status</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    {% if system_info %}
                    <div class="status-item">
                        <div class="status-label">CPU Usage</div>
                        <div class="status-bar">
                            <div class="status-fill" style="width: {{ system_info.cpu_percent }}%; background: {% if system_info.cpu_percent > 80 %}#e74c3c{% elif system_info.cpu_percent > 60 %}#f39c12{% else %}#27ae60{% endif %};"></div>
                        </div>
                        <div class="status-value">{{ "%.1f"|format(system_info.cpu_percent) }}%</div>
                    </div>
                    
                    <div class="status-item">
                        <div class="status-label">Memory Usage</div>
                        <div class="status-bar">
                            <div class="status-fill" style="width: {{ system_info.memory_percent }}%; background: {% if system_info.memory_percent > 80 %}#e74c3c{% elif system_info.memory_percent > 60 %}#f39c12{% else %}#27ae60{% endif %};"></div>
                        </div>
                        <div class="status-value">{{ "%.1f"|format(system_info.memory_percent) }}%</div>
                    </div>
                    
                    <div class="status-item">
                        <div class="status-label">Disk Usage</div>
                        <div class="status-bar">
                            <div class="status-fill" style="width: {{ system_info.disk_percent }}%; background: {% if system_info.disk_percent > 80 %}#e74c3c{% elif system_info.disk_percent > 60 %}#f39c12{% else %}#27ae60{% endif %};"></div>
                        </div>
                        <div class="status-value">{{ "%.1f"|format(system_info.disk_percent) }}%</div>
                    </div>
                    
                    <div class="status-item">
                        <div class="status-label">Uptime</div>
                        <div class="status-value" style="font-size: 1.1rem; color: #27ae60; font-weight: 600;">
                            {{ "%.1f"|format(system_info.uptime / 3600) }}h
                        </div>
                    </div>
                    {% else %}
                    <div style="grid-column: 1 / -1; text-align: center; color: #7f8c8d; padding: 20px;">
                        System monitoring unavailable
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- AI Models Status -->
            <div class="admin-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>ğŸ¤– AI Models</h3>
                    <button onclick="updateAIModels()" class="btn" style="background: #9b59b6; font-size: 0.85rem; padding: 8px 16px;">
                        ğŸ”„ Update Models
                    </button>
                </div>
                
                <div style="display: grid; gap: 15px;">
                    {% if ai_status %}
                        {% for model_name, model_info in ai_status.items() %}
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: {% if model_info.available %}#d5f4e6{% else %}#fadbd8{% endif %}; border-radius: 8px; border-left: 4px solid {% if model_info.available %}#27ae60{% else %}#e74c3c{% endif %};">
                            <div>
                                <div style="font-weight: 600; color: #2c3e50; text-transform: capitalize;">{{ model_name.replace('_', ' ') }}</div>
                                <div style="font-size: 0.85rem; color: #7f8c8d;">{{ model_info.version }}</div>
                            </div>
                            <div style="font-size: 1.2rem;">
                                {% if model_info.available %}âœ…{% else %}âŒ{% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div style="text-align: center; color: #7f8c8d; padding: 20px;">
                        AI model status unavailable
                    </div>
                    {% endif %}
                </div>
                
                <div id="ai-update-status" style="margin-top: 15px; display: none;"></div>
            </div>

            <!-- Quick Actions -->
            <div class="admin-section">
                <h3>âš¡ Quick Actions</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <button onclick="fetchRSSNow()" class="action-btn" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                        <div class="action-icon">ğŸ“¡</div>
                        <div class="action-text">Fetch RSS Now</div>
                    </button>
                    
                    <button onclick="wipeAndRegenerateImages()" class="action-btn" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                        <div class="action-icon">ğŸ”</div>
                        <div class="action-text">Wipe & Scrape Images</div>
                    </button>
                    
                    <button onclick="clearImages()" class="action-btn" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                        <div class="action-icon">ğŸ—‘ï¸</div>
                        <div class="action-text">Clear Images</div>
                    </button>
                    
                    <button onclick="generateDigest()" class="action-btn" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                        <div class="action-icon">ğŸ“‹</div>
                        <div class="action-text">Generate Digest</div>
                    </button>
                    
                    <button onclick="restartSystem()" class="action-btn" style="background: linear-gradient(135deg, #fa709a, #fee140);">
                        <div class="action-icon">ğŸ”„</div>
                        <div class="action-text">Restart System</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div>
            <!-- Navigation Links -->
            <div class="admin-section">
                <h3>ğŸ§­ Navigation</h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <a href="{{ url_for('manage_feeds', view=view_mode) }}" class="nav-link">
                        <span class="nav-icon">ğŸ“¡</span>
                        <span>Manage RSS Feeds</span>
                        <span class="nav-arrow">â†’</span>
                    </a>
                    
                    <a href="{{ url_for('events', view=view_mode) }}" class="nav-link">
                        <span class="nav-icon">ğŸª</span>
                        <span>Event Coverage</span>
                        <span class="nav-arrow">â†’</span>
                    </a>
                    
                    <a href="{{ url_for('wild_wifi', view=view_mode) }}" class="nav-link">
                        <span class="nav-icon">ğŸŒ¿</span>
                        <span>Wild Wi-Fi Stories</span>
                        <span class="nav-arrow">â†’</span>
                    </a>
                    
                    <a href="{{ url_for('weekly_digest', view=view_mode) }}" class="nav-link">
                        <span class="nav-icon">ğŸ“‹</span>
                        <span>Weekly Digest</span>
                        <span class="nav-arrow">â†’</span>
                    </a>
                    
                    <a href="{{ url_for('image_gallery', view=view_mode) }}" class="nav-link">
                        <span class="nav-icon">ğŸ–¼ï¸</span>
                        <span>Image Gallery</span>
                        <span class="nav-arrow">â†’</span>
                    </a>
                    
                    <a href="{{ url_for('social_config_page', view=view_mode) }}" class="nav-link">
                        <span class="nav-icon">ğŸ“±</span>
                        <span>Social Media Config</span>
                        <span class="nav-arrow">â†’</span>
                    </a>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="admin-section">
                <h3>ğŸ“Š Recent Activity</h3>
                <div id="recent-activity" style="font-size: 0.9rem; color: #666;">
                    <div style="padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 8px;">
                        <div style="font-weight: 600; color: #27ae60;">âœ… RSS feeds fetched</div>
                        <div style="font-size: 0.8rem; color: #7f8c8d;">{{ stats.articles_today }} new articles today</div>
                    </div>
                    
                    <div style="padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 8px;">
                        <div style="font-weight: 600; color: #3498db;">ğŸ–¼ï¸ Images generated</div>
                        <div style="font-size: 0.8rem; color: #7f8c8d;">{{ stats.get('generated_images', 0) }} total images</div>
                    </div>
                    
                    <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;">
                        <div style="font-weight: 600; color: #9b59b6;">ğŸª Events active</div>
                        <div style="font-size: 0.8rem; color: #7f8c8d;">{{ stats.get('total_events', 0) }} events tracked</div>
                    </div>
                </div>
            </div>

            <!-- System Info -->
            <div class="admin-section">
                <h3>â„¹ï¸ System Info</h3>
                <div style="font-size: 0.85rem; line-height: 1.6; color: #666;">
                    <div><strong>Version:</strong> Streamlined Edition v2.0</div>
                    <div><strong>Database:</strong> SQLite</div>
                    <div><strong>Image Engine:</strong> Ultra-Aggressive Scraping</div>
                    <div><strong>Auto-Updates:</strong> Enabled</div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.stat-card {
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.stat-icon {
    font-size: 2rem;
    margin-bottom: 10px;
}

.stat-number {
    font-size: 2.2rem;
    font-weight: 700;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
    font-weight: 500;
}

.admin-section {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 25px;
}

.admin-section h3 {
    margin: 0 0 20px 0;
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
    color: #2c3e50;
}

.status-item {
    text-align: center;
}

.status-label {
    font-size: 0.8rem;
    color: #7f8c8d;
    margin-bottom: 8px;
    font-weight: 500;
}

.status-bar {
    height: 8px;
    background: #ecf0f1;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 8px;
}

.status-fill {
    height: 100%;
    transition: width 0.3s ease;
}

.status-value {
    font-weight: 600;
    color: #2c3e50;
}

.action-btn {
    padding: 20px;
    border: none;
    border-radius: 12px;
    color: white;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
    font-family: 'Inter', sans-serif;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}

.action-icon {
    font-size: 1.8rem;
    margin-bottom: 8px;
}

.action-text {
    font-weight: 600;
    font-size: 0.9rem;
}

.nav-link {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    background: #f8f9fa;
    border-radius: 8px;
    text-decoration: none;
    color: #2c3e50;
    transition: all 0.2s ease;
}

.nav-link:hover {
    background: #e9ecef;
    transform: translateX(5px);
    text-decoration: none;
    color: #2c3e50;
}

.nav-icon {
    margin-right: 12px;
    font-size: 1.1rem;
}

.nav-arrow {
    margin-left: auto;
    color: #bdc3c7;
}
</style>

<script>
// Update current time
function updateTime() {
    const now = new Date();
    document.getElementById('current-time').textContent = now.toLocaleTimeString();
}
updateTime();
setInterval(updateTime, 1000);

// Quick Actions
async function fetchRSSNow() {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<div class="action-icon">â³</div><div class="action-text">Fetching...</div>';
    
    try {
        const response = await fetch('/api/fetch_now');
        const data = await response.json();
        
        if (data.success) {
            btn.innerHTML = '<div class="action-icon">âœ…</div><div class="action-text">Success!</div>';
            setTimeout(() => location.reload(), 1500);
        } else {
            btn.innerHTML = '<div class="action-icon">âŒ</div><div class="action-text">Failed</div>';
        }
    } catch (error) {
        btn.innerHTML = '<div class="action-icon">âŒ</div><div class="action-text">Error</div>';
    }
}

async function clearImages() {
    if (!confirm('Clear all generated images? This cannot be undone.')) return;
    
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<div class="action-icon">â³</div><div class="action-text">Clearing...</div>';
    
    try {
        const response = await fetch('/api/clear_generated_images', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            btn.innerHTML = '<div class="action-icon">âœ…</div><div class="action-text">Cleared!</div>';
            setTimeout(() => location.reload(), 1500);
        } else {
            btn.innerHTML = '<div class="action-icon">âŒ</div><div class="action-text">Failed</div>';
        }
    } catch (error) {
        btn.innerHTML = '<div class="action-icon">âŒ</div><div class="action-text">Error</div>';
    }
}

async function wipeAndRegenerateImages() {
    if (!confirm('Wipe ALL images and regenerate using ultra-aggressive scraping? This will:\n\nâ€¢ Clear all existing image URLs from database\nâ€¢ Delete all generated image files\nâ€¢ Scrape new images from article URLs\n\nThis process may take several minutes. Continue?')) return;
    
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<div class="action-icon">â³</div><div class="action-text">Processing...</div>';
    
    try {
        const response = await fetch('/api/wipe_and_regenerate_images', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            btn.innerHTML = '<div class="action-icon">âœ…</div><div class="action-text">Complete!</div>';
            
            // Show detailed results
            alert(`Ultra-Aggressive Scraping Complete!\n\n` +
                  `ğŸ“Š Results:\n` +
                  `â€¢ Cleared ${data.cleared_count} image URLs\n` +
                  `â€¢ Deleted ${data.deleted_files} image files\n` +
                  `â€¢ Processed ${data.processed_articles} articles\n` +
                  `â€¢ Successfully scraped ${data.success_count} images\n` +
                  `â€¢ Failed to find ${data.failed_count} images\n` +
                  `â€¢ Success rate: ${data.success_rate}\n\n` +
                  `ğŸ” All images now use ultra-aggressive scraping!`);
            
            setTimeout(() => location.reload(), 2000);
        } else {
            btn.innerHTML = '<div class="action-icon">âŒ</div><div class="action-text">Failed</div>';
            alert('Error: ' + (data.error || 'Unknown error occurred'));
        }
    } catch (error) {
        btn.innerHTML = '<div class="action-icon">âŒ</div><div class="action-text">Error</div>';
        alert('Network error: ' + error.message);
    }
    
    // Re-enable button after 3 seconds
    setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = '<div class="action-icon">ğŸ”</div><div class="action-text">Wipe & Scrape Images</div>';
    }, 3000);
}

async function updateAIModels() {
    const btn = event.target;
    const statusDiv = document.getElementById('ai-update-status');
    
    btn.disabled = true;
    btn.textContent = 'â³ Updating...';
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = '<div style="padding: 15px; background: #fff3cd; border-radius: 8px; color: #856404;">ğŸ”„ Updating AI models... This may take several minutes.</div>';
    
    try {
        const response = await fetch('/api/update_ai_models', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            statusDiv.innerHTML = `
                <div style="padding: 15px; background: #d4edda; border-radius: 8px; color: #155724;">
                    <div style="font-weight: 600; margin-bottom: 10px;">âœ… Update completed!</div>
                    <div style="font-size: 0.9rem;">
                        ${data.results.map(result => `<div>â€¢ ${result}</div>`).join('')}
                    </div>
                </div>
            `;
            btn.textContent = 'âœ… Updated';
            setTimeout(() => location.reload(), 3000);
        } else {
            statusDiv.innerHTML = `<div style="padding: 15px; background: #f8d7da; border-radius: 8px; color: #721c24;">âŒ Update failed: ${data.error}</div>`;
            btn.textContent = 'âŒ Failed';
        }
    } catch (error) {
        statusDiv.innerHTML = `<div style="padding: 15px; background: #f8d7da; border-radius: 8px; color: #721c24;">âŒ Network error: ${error.message}</div>`;
        btn.textContent = 'âŒ Error';
    } finally {
        btn.disabled = false;
        setTimeout(() => {
            btn.textContent = 'ğŸ”„ Update Models';
        }, 5000);
    }
}

function generateDigest() {
    window.location.href = '{{ url_for("weekly_digest", view=view_mode) }}';
}

function restartSystem() {
    if (confirm('Restart the system? This will temporarily interrupt service.')) {
        alert('System restart initiated. Please wait a moment and refresh the page.');
        // In a real implementation, this would trigger a system restart
    }
}
</script>
{% endblock %}