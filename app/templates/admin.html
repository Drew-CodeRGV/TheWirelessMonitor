{% extends "base.html" %}

{% block title %}Admin Dashboard - The Wireless Monitor{% endblock %}

{% block content %}
<h2>âš™ï¸ Admin Dashboard</h2>

<div class="stats">
    <div class="stat-box">
        <div class="stat-number">{{ stats.total_articles }}</div>
        <div class="stat-label">Total Articles</div>
    </div>
    <div class="stat-box">
        <div class="stat-number">{{ stats.active_feeds }}</div>
        <div class="stat-label">Active Feeds</div>
    </div>
    <div class="stat-box">
        <div class="stat-number">{{ stats.articles_today }}</div>
        <div class="stat-label">Today's Articles</div>
    </div>
    <div class="stat-box">
        <div class="stat-number" id="uptime">--</div>
        <div class="stat-label">Uptime (hours)</div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
    <div>
        <h3>ğŸ”§ Quick Actions</h3>
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <button onclick="fetchNow()" class="btn">ğŸ“¡ Fetch RSS Feeds Now</button>
            <button onclick="checkStatus()" class="btn">ğŸ“Š Check System Status</button>
            <a href="{{ url_for('manage_feeds') }}" class="btn">ğŸ“ Manage RSS Feeds</a>
        </div>
        
        <h3 style="margin-top: 30px;">ğŸ”„ System Management</h3>
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <button onclick="updateSystem()" class="btn" style="background: #28a745;">ğŸ”„ Update System</button>
            <button onclick="resetSystem()" class="btn btn-danger" style="background: #dc3545;">âš ï¸ Reset System (Wipe All Data)</button>
        </div>
        
        <div id="action-status" style="margin-top: 20px;"></div>
    </div>
    
    <div>
        <h3>ğŸ“ˆ System Information</h3>
        <div id="system-info" style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
            <div><strong>Status:</strong> <span id="status">Loading...</span></div>
            <div><strong>Last Fetch:</strong> <span id="last-fetch">Loading...</span></div>
            <div><strong>Version:</strong> Streamlined Edition v1.0</div>
            <div><strong>Database:</strong> SQLite (Embedded)</div>
            <div><strong>Web Server:</strong> Flask (Built-in)</div>
        </div>
    </div>
</div>

<div style="margin-top: 40px;">
    <h3>ğŸ“‹ System Features</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
            <h4>âœ… Simplified Architecture</h4>
            <ul style="margin-top: 10px; padding-left: 20px;">
                <li>Single Python service</li>
                <li>Built-in web server</li>
                <li>Embedded SQLite database</li>
                <li>Integrated task scheduler</li>
            </ul>
        </div>
        
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
            <h4>ğŸš€ Lightweight Dependencies</h4>
            <ul style="margin-top: 10px; padding-left: 20px;">
                <li>Flask (web framework)</li>
                <li>Requests (HTTP client)</li>
                <li>Feedparser (RSS parsing)</li>
                <li>BeautifulSoup (HTML parsing)</li>
            </ul>
        </div>
        
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
            <h4>âš¡ Automated Tasks</h4>
            <ul style="margin-top: 10px; padding-left: 20px;">
                <li>RSS fetching every 6 hours</li>
                <li>Automatic relevance scoring</li>
                <li>Old article cleanup</li>
                <li>No external cron needed</li>
            </ul>
        </div>
        
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
            <h4>ğŸ”„ System Management</h4>
            <ul style="margin-top: 10px; padding-left: 20px;">
                <li>One-click system updates</li>
                <li>Complete system reset option</li>
                <li>Automatic service restart</li>
                <li>Data backup during reset</li>
            </ul>
        </div>
    </div>
</div>

<script>
async function updateSystem() {
    const statusDiv = document.getElementById('action-status');
    const button = event.target;
    
    if (!confirm('This will update the system from GitHub and restart the service. Continue?')) {
        return;
    }
    
    button.disabled = true;
    button.textContent = 'â³ Updating...';
    statusDiv.innerHTML = '<div class="alert alert-success">ğŸ”„ Updating system from GitHub...</div>';
    
    try {
        const response = await fetch('/api/update_system', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            statusDiv.innerHTML = `<div class="alert alert-success">âœ… ${data.message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML += '<div class="alert alert-success">ğŸ”„ Page will reload in 10 seconds...</div>';
                setTimeout(() => location.reload(), 10000);
            }, 2000);
        } else {
            statusDiv.innerHTML = `<div class="alert alert-error">âŒ Update failed: ${data.error}</div>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<div class="alert alert-error">âŒ Network error: ${error.message}</div>`;
    } finally {
        button.disabled = false;
        button.textContent = 'ğŸ”„ Update System';
    }
}

async function resetSystem() {
    const statusDiv = document.getElementById('action-status');
    const button = event.target;
    
    if (!confirm('âš ï¸ WARNING: This will WIPE ALL DATA and reset the system to a fresh state. This cannot be undone. Are you sure?')) {
        return;
    }
    
    if (!confirm('ğŸš¨ FINAL WARNING: All RSS feeds, articles, and settings will be permanently deleted. Type YES to continue.')) {
        return;
    }
    
    button.disabled = true;
    button.textContent = 'â³ Resetting...';
    statusDiv.innerHTML = '<div class="alert alert-error">ğŸš¨ Resetting system - this may take a few minutes...</div>';
    
    try {
        const response = await fetch('/api/reset_system', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            statusDiv.innerHTML = `<div class="alert alert-success">âœ… ${data.message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML += '<div class="alert alert-success">ğŸ”„ System reset complete. Page will reload in 15 seconds...</div>';
                setTimeout(() => location.reload(), 15000);
            }, 2000);
        } else {
            statusDiv.innerHTML = `<div class="alert alert-error">âŒ Reset failed: ${data.error}</div>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<div class="alert alert-error">âŒ Network error: ${error.message}</div>`;
    } finally {
        button.disabled = false;
        button.textContent = 'âš ï¸ Reset System (Wipe All Data)';
    }
}

async function fetchNow() {
    const statusDiv = document.getElementById('action-status');
    const button = event.target;
    
    button.disabled = true;
    button.textContent = 'â³ Fetching...';
    statusDiv.innerHTML = '<div class="alert alert-success">ğŸ“¡ Fetching RSS feeds...</div>';
    
    try {
        const response = await fetch('/api/fetch_now');
        const data = await response.json();
        
        if (data.success) {
            statusDiv.innerHTML = `<div class="alert alert-success">âœ… Fetched ${data.fetched} new articles!</div>`;
            updateStats();
        } else {
            statusDiv.innerHTML = `<div class="alert alert-error">âŒ Error: ${data.error}</div>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<div class="alert alert-error">âŒ Network error: ${error.message}</div>`;
    } finally {
        button.disabled = false;
        button.textContent = 'ğŸ“¡ Fetch RSS Feeds Now';
    }
}

async function checkStatus() {
    try {
        const response = await fetch('/api/status');
        const data = await response.json();
        
        document.getElementById('status').textContent = data.status;
        document.getElementById('last-fetch').textContent = data.last_fetch;
        document.getElementById('uptime').textContent = Math.round(data.uptime / 3600);
        
        document.getElementById('action-status').innerHTML = '<div class="alert alert-success">âœ… Status updated!</div>';
    } catch (error) {
        document.getElementById('action-status').innerHTML = `<div class="alert alert-error">âŒ Error checking status: ${error.message}</div>`;
    }
}

function updateStats() {
    // Reload page to update stats
    setTimeout(() => location.reload(), 1000);
}

// Load status on page load
document.addEventListener('DOMContentLoaded', checkStatus);

// Auto-refresh status every 30 seconds
setInterval(checkStatus, 30000);
</script>

{% endblock %}